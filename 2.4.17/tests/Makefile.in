.PHONY: strip clean

# Variables
SRC = ../src/
BIN = ../bin/
BINPGO = ../binpgo/
CC = @CC@ @ARCH@ @LTO@
CFLAGS = @CFLAGS@ @GLIB_CFLAGS@ @GTOP_CFLAGS@ -DJBW=1 @PRECISION@ \
	@GSL_CFLAGS@ -I$(SRC) -O3 -pedantic -Wall -Wextra
LDFLAGS = @LDFLAGS@ @GLIB_LIBS@ @GTOP_LIBS@ @GSL_LIBS@ @LIBS@
src = $(SRC)jb_config.h $(SRC)jb_def.h $(SRC)jb_def.c $(SRC)jb_math.h \
	$(SRC)jb_math.c
exe = index_sort check_sort

indexdep = index_sort.c Makefile
checkdep = check_sort.c Makefile
PGO = @PGO@
ifeq ($(PGO), 1)
	PGOGENERATE = -fprofile-generate
	PGOUSE = -fprofile-use -fprofile-correction
	INDEXDEP = index_sortpgo
	CHECKDEP = check_sortpgo
else
	INDEXDEP = $(indexdep)
	CHECKDEP = $(checkdep)
endif

# Default building
all: $(exe)

# PGO tests
index_sortpgo: $(indexdep)
	$(CC) $(CFLAGS) $(PGOGENERATE) index_sort.c -o index_sortpgo $(LDFLAGS) \
		-L$(BINPGO) -Wl,-rpath=$(BINPGO) -ljbm -ljb
	./index_sortpgo 10000 1000 0 1
	./index_sortpgo 10000 1000 0 2
	./index_sortpgo 10000 1000 0 3
	./index_sortpgo 10000 1000 0 4
check_sortpgo: $(checkdep)
	$(CC) $(CFLAGS) $(PGOGENERATE) check_sort.c -o check_sortpgo $(LDFLAGS) \
		-L$(BINPGO) -Wl,-rpath=$(BINPGO) -ljbm -ljb
	./check_sortpgo 1000 1
	./check_sortpgo 1000 2
	./check_sortpgo 1000 3
	./check_sortpgo 1000 4

# Tests
index_sort: $(INDEXDEP)
	$(CC) $(CFLAGS) $(PGOUSE) index_sort.c $(obj) -o index_sort $(LDFLAGS) \
		-L$(BIN) -Wl,-rpath=$(BIN) -ljbm -ljb
check_sort: $(CHECKDEP)
	$(CC) $(CFLAGS) $(PGOUSE) check_sort.c $(obj) -o check_sort $(LDFLAGS) \
		-L$(BIN) -Wl,-rpath=$(BIN) -ljbm -ljb

# Final version
strip:
	@MAKE@
	strip $(exe)

# Clean
clean:
	rm -rf doc $(exe) *.o *pgo *.gcda
